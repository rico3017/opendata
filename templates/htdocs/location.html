<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="./assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title id="pageTitle">
    Open Finder - Your Properties Finder in London
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="./assets/css/material-kit.css?v=2.0.5" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="./assets/demo/demo.css" rel="stylesheet" />
</head>

<!-- Global Header and Footer -->
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script> 
    $(function(){
        $("#header").load("./commons/header.html");
        $("#footer").load("./commons/footer.html");
    });
</script> 

<body class="index-page sidebar-collapse">
  <div id="header"></div>
  
  <main>
  <div class="section section-white">
    <div class="container">
      <div class="row">
        <div class="col-md-10  ml-auto  mr-auto">
          <div class="form-group">
            <label for="exampleInput1" class="bmd-label-floating navbar-brand">Search</label>
                <input type="search" class="form-control" id="search_input">
            <span class="bmd-help" style="color: white" id="search_hints">Enter a Postcode to continue</span>
          </div>
        </div>
		<div class="col-md-2" align="right">
			<br>
			<button class="btn btn-info" onclick="locationDetails()">Search</button>
		</div>
      </div>
    </div>
  </div>
  <div class="">
    <div class="text-center">
        <div class="row">
          <div class="col-md-8 ml-auto mr-auto text-center">
			<h2 id="location_postcode"></h2>
			<div id="avgPrice">
				Loading...
			</div>
			<div id="getCrime"></div>
		  </div>
		</div>
	</div>
    <div class="cd-section" id="image_details">
      <div class="container">
        <!--                 modals -->
        <div class="row" id="modals">
			<div class="col-md-6">
				<div class="card card-nav-tabs">
					<div class="card-header card-header-primary">
					  <!-- colors: "header-primary", "header-info", "header-success", "header-warning", "header-danger" -->
					  <div class="nav-tabs-navigation">
						<div class="tab-pane active">
						  Transaction Records
						</div>
					  </div>
					</div>
					<div class="card-body" >
					  <div class="tab-content text-left">
						<div id="table-wrapper">
							<div id="table-scroll">
								<table id="search_result">
									<tbody>
										<tr><td width="30%">Loading...</td></tr>
									</tbody>
								</table>
								
							</div>
						</div>
						PO: Pre-Owned Property
					  </div>
					</div>
				</div>
			</div>
          <div class="col-md-6">
			  <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel" data-interval="3000">
				<ol class="carousel-indicators">
				  <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
				  <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
				</ol>
				<div class="carousel-inner">
				  <div class="carousel-item active">
					<img class="d-block w-100" src="./imgs/house0.png" alt="First slide">
					<div class="carousel-caption d-none d-md-block">
					  <h4>
						<i class="material-icons">schedule</i> 2015, provided by COMP6214 Agency .Ltd
					  </h4>
					</div>
				  </div>
				  <div class="carousel-item">
					<img class="d-block w-100" src="./imgs/house1.png" alt="Second slide">
					<div class="carousel-caption d-none d-md-block">
					  <h4>
						<i class="material-icons">schedule</i> 2009, uploaded by Rico on Google Map.
					  </h4>
					</div>
				  </div>
				</div>
				<a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
				  <i class="material-icons">keyboard_arrow_left</i>
				  <span class="sr-only">Previous</span>
				</a>
				<a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
				  <i class="material-icons">keyboard_arrow_right</i>
				  <span class="sr-only">Next</span>
				</a>
			  </div>
          </div>
          
        </div>
        <!--                 end modals	             -->
      </div>
    </div>
	<div class="container">
		<div class="main " >
		
		<div class="col-lg-6 col-md-12">
		  <div class="row">
			<div class="col-md-3">
			  <ul class="nav nav-pills nav-pills-icons flex-column " role="tablist">
				<!--
									color-classes: "nav-pills-primary", "nav-pills-info", "nav-pills-success", "nav-pills-warning","nav-pills-danger"
								-->
				<li class="nav-item">
				  <a class="nav-link active" href="#dashboard-2" role="tab" data-toggle="tab">
					<i class="material-icons">settings</i>Internet
				  </a>
				</li>
				<li class="nav-item">
				  <a class="nav-link" href="#schedule-2" role="tab" data-toggle="tab">
					<i class="material-icons">warning</i>Crime
				  </a>
				</li>
			  </ul>
			</div>
			<div class="col-md-8">
			  <div class="tab-content text-center center">
				<div class="tab-pane active" id="dashboard-2">
					<div id="getNetwork">Loading...</div>
				</div>
				<div class="tab-pane" id="schedule-2">
					<div id="getCrimes">Loading...</div>
				</div>
			  </div>
			</div>
		  </div>
		</div>
		</div>
	</div>
	<div class="section cd-section" id="image_details">
      <div class="container">
        <!--                 modals -->
        <div class="row" id="modals">
          <div class="col-md-6">
			<iframe id="londonmap" width="480" height="480" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=-1.4022481441497803%2C50.93230676956965%2C-1.3906610012054443%2C50.93806739952225&amp;layer=mapnik&amp;marker=50.935187173743714%2C-1.3964545726776123" style="border: 1px solid black"></iframe>
			<br/>
			<small>
				<button id="btn_londonmap" class="btn btn-primary btn-round" onclick="">View Larger Map</button>
			</small>
          </div>
          <div class="col-md-6">
			  <!-- Tabs on Plain Card -->
              <div class="card card-nav-tabs card-plain">
                <div class="card-header card-header-warning">
                  <!-- colors: "header-primary", "header-info", "header-success", "header-warning", "header-danger" -->
                  <div class="nav-tabs-navigation">
                    <div class="nav-tabs-wrapper">
                      Comments
                    </div>
                  </div>
                </div>
                <div class="card-body ">
                  <div class="tab-content text-center">
					Do you wanna know more about how's the others think about this property?
					<br>
					<a href="./constructing">Login</a> to get access to the comments or <a href="./constructing">register</a>
                    <img src="./imgs/comments.png" alt="Advertisment" class="rounded img-fluid">
                  </div>
                </div>
              </div>
              <!-- End Tabs on plain Card -->
          </div>
        </div>
        <!--                 end modals	             -->
      </div>
    </div>
	<div class="container">
		<div class="main main-raised" >
          <h3>Trasportation Nearby</h3>
			<div>
				<table id="transportation_result" style="width: 100%;">
					<tbody>
						<tr>
							<td>
								
							</td>
						</tr>
						<tr>
							<td>
								Loading...
							</td>
						</tr>
						
					</tbody>
				</table>
			</div>
		</div>
	</div>
	
 
  </main>
  
  <div id="footer"></div>
  
  <!--   Core JS Files   -->
  <script src="./assets/js/core/jquery.min.js" type="text/javascript"></script>
  <script src="./assets/js/core/popper.min.js" type="text/javascript"></script>
  <script src="./assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
  <script src="./assets/js/plugins/moment.min.js"></script>
  <!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
  <script src="./assets/js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
  <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
  <script src="./assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
  <!--  Google Maps Plugin    -->
  <!-- <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script> -->
  <!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
  <script src="./assets/js/material-kit.js?v=2.0.5" type="text/javascript"></script>
  <script>
    $(document).ready(function() {
      //init DateTimePickers
      materialKit.initFormExtendedDatetimepickers();

      // Sliders Init
      materialKit.initSliders();
    });


    function scrollToDownload() {
      if ($('.section-download').length != 0) {
        $("html, body").animate({
          scrollTop: $('.section-download').offset().top
        }, 1000);
      }
    }

  </script>
  <script>
	var url = new URL(location.href);
	var postcode="";
	var street="";
	var lat="0";
	var loc="0";
	postcode = url.searchParams.get("postcode");
	if (postcode === undefined || postcode=="") {
		location.replace("./home?message=err");
	}
	
	function getHousePrice() {
		var chkbox_yes = "<div class=\"form-check disabled\">" + "<label class=\"form-check-label\">" + "<input class=\"form-check-input\" type=\"checkbox\" disabled checked>" + "<span class=\"form-check-sign\">" + "<span class=\"check\"></span>"  + "</span>" + "</label>" + "</div>";
		var chkbox_no = "<div class=\"form-check disabled\">" + "<label class=\"form-check-label\">" + "<input class=\"form-check-input\" type=\"checkbox\" disabled>" + "<span class=\"form-check-sign\">" + "<span class=\"check\"></span>"  + "</span>" + "</label>" + "</div>";
	
		
		d3.json("{{ url_for('house.price') }}" + "?postcode=" + postcode, function(error, data) {
			if (data['result'] === undefined || data['result'].length == 0) {
				alert_info = "<div class=\"alert alert-danger\">" + contsiner + "</div>";
				document.getElementById("search_target").innerHTML = alert_info;
				document.getElementById("search_result").innerHTML = "<tbody><tr><td>No records.</td></tr></tbody>";
				
			}else {
				table_content = "<tr class=\"header\"><thead><th>PO</th><th>£</th><th>No.</th><th>Date</th></thead></tr><tbody>";
				disp_loc ="";
				for (i = 0; i < data['result'].length; i++) {
					property = data['result'][i];
					street = property["address"]["street"];
					disp_loc = property["address"]["street"] + " (" + property["address"]["postcode"] + ")";
					
					table_content += "<tr>";
						table_content += "<td>";
							if (property["new"] == "false") {
								table_content += chkbox_yes;
							}else {
								table_content += chkbox_no;
							}
						table_content += "</td>";
						table_content += "<td>";
							table_content += property["price"];
						table_content += "</td>";
						table_content += "<td>";
							table_content += property["address"]["saon"];
						table_content += "</td>";
						table_content += "<td>";
							table_content += property["transaction_date"];
						table_content += "</td>";
					table_content += "</tr>";
				}
				table_content += "</tbody>";
				document.getElementById("search_result").innerHTML = table_content;
				document.getElementById("location_postcode").innerHTML = disp_loc;
				
			}
			
			getTransporation();
		});
	
		getLocationGPS();
		
	}
	
	function getAvgPrice() {
		var pheader="<table><tr><thead>";
		var pbody="<tbody><tr>"
		
		d3.json("{{ url_for('house.avgPrice') }}" + "?postcode=" + postcode, function(error, data) {
			if (data['result'].length == 0) {
				pheader+="<th></th>";
				pbody+="<td>No Average Sales Data</td>";
			}else {
				pheader+="<th></th>";
				pbody+="<td>avg. of sales</td>";
				data['result'].forEach(function(avgp){
					pheader+="<th>" + avgp['type'] + "</th>";
				pbody+="<td>£" + avgp['avg_price']  + "</td>";
				});
			}
			pbody += "</tr></tbody>" + "</thead></tr>";
			pheader += pbody;
			document.getElementById("avgPrice").innerHTML = pheader;
		});
		
	}
	
	function getNetwork() {
		var nheader="<table><tr><thead>";
		var nbody="<tbody><tr>"
		
		d3.json("{{ url_for('london.getNetwork') }}" + "?postcode=" + postcode, function(error, data) {
			nheader+="<th>Average Upload Speed</th><th>Average Download Speed</th></thead></tr>";
			nbody+="<td>" + data['result']['avg_download'] + "(Mbps)</td><td>" + data['result']['avg_upload'] + "(Mbps)</td></tr></tbody></table>";
			nheader+=nbody;
			document.getElementById("getNetwork").innerHTML = nheader;
		});
		
	}
	
	
	function getLocationGPS() {
		d3.json("{{ url_for('london.getloc') }}" + "?postcode=" + postcode, function(error, data) {
			lat = data["result"]["lat"];
			lon = data["result"]["lon"];
			latlon = lat+'%2C'+lon;
			lonlat = lon+'%2C'+lat;
			
			mapurl="https://www.openstreetmap.org/export/embed.html?bbox=" + lonlat + "%2C" + lonlat + "&layer=mapnik&marker=" + latlon;
			btnurl="https://www.openstreetmap.org/?mlat=" + lat + "&mlon=" + lon + "#map=17/" + lat + "/" + lon;
			document.getElementById("londonmap").setAttribute('src', mapurl);
			document.getElementById("btn_londonmap").setAttribute('onclick', "window.open('" + btnurl + "','_blank')");
			
			getCrime();
		});
		
	}
	
	function getCrime() {
		//http://127.0.0.1:5000/london/getCrime/?latitude=51.9&longitude=-0.7
		var cheader="<table><tr><thead>";
		var cbody="<tbody><tr>"
		
		d3.json("{{ url_for('london.getCrime') }}" + "?latitude=" + lat + "&longitude=" + lon, function(error, data) {
			cheader+="<th>Anti-social</th><th>Criminal Damage</th><th>Drugs</th><th>Public Disorder</th><th>Violent</th></thead></tr>";
			cbody+="<td>" + data['result']['anti-social-behaviour'] + "</td><td>" + data['result']['criminal-damage-arson'] + "</td><td>" + data['result']['drugs'] + "</td><td>" + data['result']['public-order'] + "</td><td>" + data['result']['violent-crime'] + "</td></tr></tbody></table><br>Data gathered from " + data["one_year"][0] + " to " + data["one_year"][data["one_year"].length-1];
			cheader+=cbody;
			console.log(cheader);
			document.getElementById("getCrimes").innerHTML = cheader;
		});
		
	}
	
	function getTransporation() {
		d3.json("./london/nearbyTrans/" + "?street=" + street, function(error, data) {
			if (data['result'].length == 0) {
				document.getElementById("transportation_result").innerHTML = "<tr class=\"header\"><tbody><td>No Public Transportation is Nearby</td></tbody></tr>";
			}else{
				table_content = "<tr class=\"header\"><thead><th>Stop/ Station</th><th>Type(s)</th><th>Route(s)</th></thead></tr><tbody>";
				data['result'].forEach(function(transport){
					table_content += "<tr>";
						table_content += "<td rowspan=" + transport["groups"].length + ">";
							table_content += transport["name"];
						table_content += "</td>";
						table_content += "<td>";
							table_content += transport["groups"][0]["mode"];
						table_content += "</td>";
						table_content += "<td>";
							table_content += transport["groups"][0]["lines"][0];
							for(i=1; i<transport["groups"][0]["lines"].length; i++) {
								table_content += ", " + transport["groups"][0]["lines"][i];
							}
						table_content += "</td>";
					table_content += "</tr>";
					for (i=1; i < transport["groups"].length; i++) {
						table_content += "<tr>";
							table_content += "<td>";
								table_content += transport["groups"][i]["mode"];
							table_content += "</td>";
							table_content += "<td>";
								table_content += transport["groups"][i]["lines"][0];
								for(j=1; j<transport["groups"][i]["lines"].length; j++) {
									table_content += ", " + transport["groups"][i]["lines"][j];
								}
							table_content += "</td>";
						table_content += "</tr>";
					}
				});
				table_content += "</tbody>";
				console.log(table_content);
				document.getElementById("transportation_result").innerHTML = table_content;
			}
		});
	}
	
	function locationDetails() {
		location.href = "{{ url_for('location') }}" + "?postcode=" + document.getElementById("search_input").value;
	}
	
	//http://127.0.0.1:5000/london/nearbyTrans/?street=FINCHLEY%20ROAD
	//http://localhost:5000/london/getCrime/?latitude=52.629729&longitude=-1.131592&date=2017-01
	getHousePrice();
	getAvgPrice();
	getNetwork();
  </script>
</body>

</html>
